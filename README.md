# ChGK Org Bot

[ChGKOrgBot](https://t.me/gamepollbot) - это Telegram-бот, предназначенный для помощи организаторам ЧГК в поиске турниров и создании опросов для выбора ближайших игр. А также получения уведомлений о поданных заявках.
Бот интегрируется с API [Турнирного сайта сообщества знатоков](https://rating.chgk.info) для получения актуальной информации о турнирах и заявках.

## Основные возможности

*   **Поиск турниров:**
    *   `/tourns <дата>`: Показывает список всех синхронных и асинхронных турниров на указанную дату и время. Дату можно указывать в формате `ГГГГММДД` или словами (например, "завтра в 18", "в субботу 13:00"). Если время не указано, то берется день целиком.
    *   `/rtourns <дата>`: Аналогично `/tourns`, но показывает только рейтингуемые турниры.
*   **Создание опросов:**
    *   `/poll <номера_турниров> [название_опроса] [до <время_окончания>]`: Создает опрос в чате для выбора одного или нескольких турниров из списка, полученного командой `/tourns` или `/rtourns`. Номера турниров указываются через запятую.
        *   Пример: `/poll 1,3,5 Играем в эти выходные до пятницы 20:00`
*   **Управление опросами:**
    *   `/stop` (в ответ на сообщение с опросом): Завершает опрос и объявляет победителя(ей).
    *   `/cancel` (в ответ на сообщение с опросом): Завершает опрос без объявления результатов.
*   **Настройка чата:**
    *   `/setupchat <часовой_пояс> [ID_площадки1,ID_площадки2,...]`: Настраивает часовой пояс для корректного отображения времени турниров и список ID площадок с сайта рейтинга для мониторинга новых заявок. Эта функцию можно использовать и просто для настройки уведомлений о новых заявках.
        *   Пример: `/setupchat Europe/Moscow 3053,1024`
*   **Автоматические уведомления:**
    *   Бот периодически проверяет наличие новых заявок на турниры от указанных площадок и уведомляет чат.
    *   Автоматически завершает опросы по истечении указанного времени (если оно было задано при создании опроса).
*   **Справка:**
    *   `/help`: Показывает справку по всем командам.

## Принцип работы

1.  Пользователь отправляет команду боту (например, `/tourns понедельник 19:00`).
2.  Бот обрабатывает команду, при необходимости обращается к API [Турнирного сайта сообщества знатоков](https://rating.chgk.info).
3.  Бот отправляет в чат результат - список турниров с краткими описаниями.
4.  По списку можно создать опрос со сроком окончания. Результат подводится автоматически по истечении срока. В случае нескольких победителей, бот выбирает случайного их них.

## Запуск и настройка (для разработчиков)

Проект написан на Python с использованием Flask и предназначен для развертывания на Google App Engine.

1.  **Переменные окружения:**
    Перед запуском необходимо настроить следующие переменные окружения (в файле `env.yaml`, созданном из `env_template.yaml`):
    *   `PROJECT_ID`: ID вашего проекта в Google Cloud.
    *   `TELEGRAM_API_TOKEN`: Токен вашего Telegram-бота.
    *   `OBFUSCATION_TOKEN`: Произвольная строка для обфускации URL веб-хука.

2.  **Веб-хук:**
    Для работы бота необходимо установить веб-хук для Telegram. URL веб-хука должен указывать на эндпоинт `/command<YOUR_WEBHOOK_OBFUSCATION_TOKEN>` вашего развернутого приложения.
    Для Google App Engine это: `https://<YOUR_PROJECT_ID>.appspot.com/command<YOUR_WEBHOOK_OBFUSCATION_TOKEN>`
    Установить веб-хук можно, обратившись к эндпоинту `https://<YOUR_PROJECT_ID>.appspot.com/setwebhook` вашего развернутого приложения один раз.
